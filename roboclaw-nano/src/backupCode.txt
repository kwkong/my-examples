#include <Arduino.h>
#include <Wire.h> 
#include <LiquidCrystal_I2C.h>

#define potPinSpeed A0
#define potPinVol A1
#define potPinPos A2

#define buzzPin 2
#define startPin 4
#define decreasePin 6
#define increasePin 7
#define stopPin 12

#define ENA 3
#define IN1 11
#define IN2 10
#define IN3 9
#define IN4 8
#define ENB 5

#define potValTop 675
#define potValBot 770

float speed,speedOld = 0;
int displaySpeed,speedPWM = 0;
int potValPos, potValSpeed, potValVol = 0;
int state = 0;

unsigned long spinTime = 0;
int spinDir = 0;

boolean start, startOld = false;

LiquidCrystal_I2C lcd(0x3F, 16, 2);

void motorRotate(int direction, int speed)
{
    if (direction == 1)
    {
        analogWrite(ENA, speed);
        analogWrite(ENB, speed);

        digitalWrite(IN1, HIGH);
        digitalWrite(IN2, LOW);

        digitalWrite(IN3, HIGH);
        digitalWrite(IN4, LOW);

    } 
    else if(direction == 0) 
    {

        analogWrite(ENA, speed);
        analogWrite(ENB, speed);

        digitalWrite(IN1, LOW);
        digitalWrite(IN2, HIGH);

        digitalWrite(IN3, LOW);
        digitalWrite(IN4, HIGH);        
    }
}

void motorStop()
{
    digitalWrite(ENA, LOW);
    digitalWrite(ENB, LOW);

    digitalWrite(IN1, LOW);
    digitalWrite(IN2, LOW);

    digitalWrite(IN3, LOW);
    digitalWrite(IN4, LOW);  
}

void beepOnce()
{
    digitalWrite(buzzPin, HIGH);
    delay(30);
    digitalWrite(buzzPin, LOW);
    delay(30);
}

void setup()
{
    pinMode(increasePin, INPUT_PULLUP);
    pinMode(stopPin, INPUT_PULLUP);
    pinMode(decreasePin, INPUT_PULLUP);
    pinMode(startPin, INPUT_PULLUP);
    pinMode(potPinPos, INPUT);
    pinMode(potPinVol, INPUT);
    pinMode(potPinSpeed, INPUT);
    pinMode(ENA, OUTPUT);
    pinMode(ENB, OUTPUT);
    pinMode(buzzPin, OUTPUT);

    Serial.begin(115200);

    Serial.println("Ready");

    // while(1)
    // {
    //     potVal = analogRead(A0);
    //     Serial.println(potVal);
    //     delay(150);
    // }


}

void loop()
{
    if(!digitalRead(stopPin))
    {
        motorStop();
        Serial.println("HALT");
        while(1)
        {
            motorStop();
            if (!digitalRead(increasePin))
            {
                motorRotate(1,100);
                delay(100);
                motorStop();
            }

            if (!digitalRead(decreasePin))
            {
                motorRotate(0,100);
                delay(100);
                motorStop();
            }
        }
    }

    if (!digitalRead(increasePin))
    {
        motorRotate(1,100);
        delay(200);
        motorStop();
    }

    if (!digitalRead(decreasePin))
    {
        motorRotate(0,100);
        delay(200);
        motorStop();
    }

    if (!digitalRead(startPin))
    {
        while(!digitalRead(startPin));
        start = !start;
        Serial.print("Start: ");
        Serial.println(start);
    }

    if(start)
    {
        potValPos = analogRead(potPinPos);
        potValVol = analogRead(potPinVol);
        potValSpeed = analogRead(potPinSpeed);

        potValSpeed = map(potValSpeed, 0, 1023, 0, 255);
        potValVol = map(potValVol, 0, 1023, 50, 0);

        if ((potValPos < ((potValBot-5)-potValVol)) && (state == 0))  //if not at bottom, go down
        {
            motorRotate(1, potValSpeed);
            Serial.println("Going down");

        } 
        else if((potValPos > (potValTop+5)))       // if not at top, go up
        {
            state = 1;
            motorRotate(0, potValSpeed);
            Serial.println("Going up");
        }
        else if(potValPos <= (potValTop+5)) 
        {
            state = 0;
        } 
    } 
    
    else 
    {
        motorStop();
        potValPos= analogRead(A0);
        Serial.println(potValPos);
        //delay(150);
    }
    
}


