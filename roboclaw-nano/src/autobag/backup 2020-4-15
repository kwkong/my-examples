#include <Arduino.h>
#include <Wire.h> 
#include <LiquidCrystal_I2C.h>

#define potPinSpeed A0
#define potPinVol A1
#define potPinPos A2

#define buzzPin 2
#define startPin 4
#define decreasePin 6
#define increasePin 7
#define stopPin 12

#define ENA 5
#define IN1 8
#define IN2 9
#define IN3 10
#define IN4 11
#define ENB 3

#define potValTop 715
#define potValBot 800
#define potValThresh 1

float speed,speedOld = 0;
int displaySpeed,speedPWM = 0;
int potPosition, potSpeed, potVolume, potSpeedOld, potVolumeOld = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
int state = 0;
int resetState = 0;

unsigned long holdTime, clearTime = 0;
int spinDir = 0;

boolean start, startOld = false;

LiquidCrystal_I2C lcd(0x3F, 16, 2);

void motorRotate(int direction, int speed)
{
    if (direction == 1)
    {
        analogWrite(ENA, speed);
        analogWrite(ENB, speed);

        digitalWrite(IN1, HIGH);
        digitalWrite(IN2, LOW);

        digitalWrite(IN3, HIGH);
        digitalWrite(IN4, LOW);

    } 
    else if(direction == 0) 
    {

        analogWrite(ENA, speed);
        analogWrite(ENB, speed);

        digitalWrite(IN1, LOW);
        digitalWrite(IN2, HIGH);

        digitalWrite(IN3, LOW);
        digitalWrite(IN4, HIGH);        
    }
}

void motorStop()
{
    digitalWrite(ENA, LOW);
    digitalWrite(ENB, LOW);

    digitalWrite(IN1, LOW);
    digitalWrite(IN2, LOW);

    digitalWrite(IN3, LOW);
    digitalWrite(IN4, LOW);  
}

void beepOnce()
{
    digitalWrite(buzzPin, HIGH);
    delay(30);
    digitalWrite(buzzPin, LOW);
    delay(30);
}

void setup()
{
    pinMode(increasePin, INPUT_PULLUP);
    pinMode(stopPin, INPUT_PULLUP);
    pinMode(decreasePin, INPUT_PULLUP);
    pinMode(startPin, INPUT_PULLUP);

    pinMode(potPinPos, INPUT);
    pinMode(potPinVol, INPUT);
    pinMode(potPinSpeed, INPUT);

    pinMode(ENA, OUTPUT);
    pinMode(ENB, OUTPUT);
    pinMode(buzzPin, OUTPUT);

    Serial.begin(115200);
    lcd.init();
	lcd.backlight();

    beepOnce();
    beepOnce();

	lcd.print("System Start");
    delay(1000);
    lcd.clear();

    potVolume = analogRead(potPinVol);
    potSpeed = analogRead(potPinSpeed);

    potSpeed = map(potSpeed, 0, 1023, 255, 0); //map pot value to pwm
    potVolume = map(potVolume, 0, 1023, 50, 0); 

    lcd.setCursor(0,0);
    lcd.print("Speed: ");
    lcd.setCursor(7, 0);
    lcd.print(potSpeed);

    lcd.setCursor(0,1);
    lcd.print("Volume: ");
    lcd.setCursor(8, 1);
    lcd.print(potVolume);

    Serial.println("Ready");
}

void loop()
{
    potPosition = analogRead(potPinPos);
    potVolume = analogRead(potPinVol);
    potSpeed = analogRead(potPinSpeed);

    potSpeed = map(potSpeed, 0, 1023, 255, 0); //map pot value to pwm
    potVolume = map(potVolume, 0, 1023, 50, 0);     //map pot value height offset for minimum arm height


    if(
        (potVolumeOld < (potVolume-potValThresh)) || 
        (potVolumeOld > (potVolume+potValThresh)) ||

        (potSpeedOld < (potSpeed-potValThresh)) || 
        (potSpeedOld > (potSpeed+potValThresh)) 
    )
    {
        if ((millis() - clearTime) > 100)
        {
            clearTime = millis();
            lcd.clear();

            lcd.setCursor(0,0);
            lcd.print("Speed: ");
            lcd.setCursor(7, 0);
            lcd.print(potSpeed);

            lcd.setCursor(0,1);
            lcd.print("Volume: ");
            lcd.setCursor(8, 1);
            lcd.print(potVolume);

            potVolumeOld = potVolume;
            potSpeedOld = potSpeed;
        }

    }

    if(!digitalRead(stopPin)) //if failsafe is button 
    {
        motorStop();

        lcd.clear();
        lcd.setCursor(0,0);
        lcd.print("HALT");

        Serial.println("HALT");

        resetState = 0;

        while(resetState == 0)
        {
            motorStop();
            if (!digitalRead(increasePin))
            {
                Serial.println("up");
                beepOnce();
                motorRotate(1,100);
                delay(100);
                motorStop();
            }

            if (!digitalRead(decreasePin))
            {
                Serial.println("down");
                beepOnce();
                motorRotate(0,100);
                delay(100);
                motorStop();
            }

            if(!digitalRead(startPin))
            {
                holdTime = millis();
                while(!digitalRead(startPin))
                {
                    if((millis() - holdTime) > 4000)
                    {
                        beepOnce();
                        beepOnce();
                        delay(200);
                        beepOnce();
                        resetState = 1;
                        break;
                    }
                }
            }
        }
    }

    if (!digitalRead(decreasePin))
    {
        Serial.println("down");
        beepOnce();
        motorRotate(1,100); 
        delay(200);
        motorStop();
    }

    if (!digitalRead(increasePin))
    {
        Serial.println("up");
        beepOnce();
        motorRotate(0,100);
        delay(200);
        motorStop();
    }

    if (!digitalRead(startPin))
    {
        beepOnce();
        while(!digitalRead(startPin));
        start = !start;
        Serial.print("Start: ");
        Serial.println(start);
    }

    if(start)
    {
        if ((potPosition < ((potValBot-5)-potVolume)) && (state == 0))  //if not at bottom, go down
        {
            motorRotate(1, potSpeed);
            Serial.print("Going down ");
            Serial.println(potPosition);
        } 
        else if((potPosition > (potValTop+5)))       // if not at top, go up
        {
            state = 1;     //blocks the code from lowering the arm until the arm reaches the top
            motorRotate(0, potSpeed);
            Serial.print("Going up ");
            Serial.println(potPosition);        }
        else if(potPosition <= (potValTop+5)) 
        {
            state = 0;      //allows the code to begin lowering the arm after the arm reaches the top
        } 
    } 
    
    else 
    {
        motorStop();
        Serial.println(potPosition);
    }
    
}


